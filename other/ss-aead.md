# SS 密码单端口优化

!> 最新的 ss2022 加密方式设计了不同的协议，`无需关心验证性能问题`

# ss 密码单端口设计原理
 - 针对每个 tcp 连接，会轮流使用每个用户的密码进行解密，直到找到能正确解密数据头的用户密码
 - 针对每个 udp 数据包，会轮流使用每个用户的密码进行解密，直到找到能正确解密该数据的用户密码

## 结论
由于以上特性，`理想情况下`平均每个`tcp 连接`/`udp 数据包`都会使用`一半数量的用户密码`尝试进行解密才能找到正确的用户，此机制会导致在验证用户期间`消耗大量 cpu`(在解密 udp 数据包时尤为明显)

当服务端仅有极少量用户时，此时的性能损耗对于现代 cpu 来说几乎可以忽略。但服务端中的用户越多，同时使用的用户也越多，cpu 占用率将会`急剧升高`，甚至占满 cpu，导致用户无法正常使用

# heki 优化

heki 针对 ss 密码单端口进行了`深度优化`，可以`很大程度改善` ss 密码单端口的 cpu 占用率，基本让 ss 密码单端口与其他协议的验证用户的性能处于`同一量级`

heki 的 SS2022 实现采用 O(1) 用户身份映射（iPSK identity map），完全避免了遍历用户的性能问题

## 真实 IP 缓存优化

只要让 heki 能`正确获取到用户真实 ip`，heki 会自动开启优化

如果用户直连 heki 服务端，则无需关心，此优化已开启

如果你使用了中转服务器，则需确保 heki `能正确获取到用户真实 ip`，详情参考: [这里](other/forward-get-real-ip.md)

此优化可以完全解决验证用户导致的 cpu 占用率爆满问题，但可能需要考虑特殊情况，例如`错误密码攻击`

### 相关配置

| 参数名                         | 默认值          | 说明                                    |
|-----------------------------|--------------|---------------------------------------|
| `ip_user_cache_time`        | `24`         | 用户 IP 缓存时间，单位: 小时                     |
| `ip_user_cache_save_enable` | `true`       | 用户 IP 缓存是否自动保存到硬盘，可有效解决重启后缓存丢失的问题，建议开启 |
| `ip_user_cache_save_dir`    | `/etc/heki/` | 用户 IP 缓存保存文件夹                         |

## 错误密码攻击优化

当用户使用错误的密码连接时，服务端`尝试所有的用户`进行`解密`数据包，最终抛出`未找到用户`的错误

每一个`错误密码`的 tcp 连接和 udp 数据包，都会让服务端`重复上述流程`，`极大增加`了服务器的 cpu 使用率，降低正常用户的体验

若这样的`错误密码`连接很多，例如攻击者`恶意攻击服务端`，服务器 cpu 占用率`直接爆满`，用户无法正常使用

### 配置
| 参数名                                | 默认值     | 说明           |
|------------------------------------|---------|--------------|
| `ss_invalid_access_enable`         | `false` | 是否启用错误密码攻击优化 |
| `ss_invalid_access_count`          | `30`    | 错误次数         |
| `ss_invalid_access_duration`       | `60`    | 错误次数统计时间，单位秒 |
| `ss_invalid_access_forbidden_time` | `600`   | 禁用时间，单位秒     |

### 功能描述

!> 此功能必须确保 heki `获取到真实 IP`，否则不要开启此功能，[中转获取真实IP](other/forward-get-real-ip.md)

!> `强烈建议`根据你的实际情况修改配置，默认配置`未经过任何实战`

!> 此功能有可能导致误伤正常用户，例如：用户`误操作`使用了错误的密码进行连接，`触发错误次数统计`导致被暂时封禁

以`默认配置`为例，当某个 IP 在`60`秒内`使用错误密码`尝试连接`30`次后，将会禁用此 IP`600`秒

在封禁期间，此 IP 无论使用正确密码或错误密码连接，服务端均`直接关闭连接`，不会继续消耗服务器 cpu 进行尝试解密
