# VMessAEAD 说明

`VMessAEAD`是 v2ray-core v4.28 开始启用的新的认证方式，与旧的`VMessMD5`不兼容，目前通过**同时检测两种认证方式来实现兼容**

当用户`alterId`为`0`时，表示该用户可以使用`VMessAEAD`或`VMessMD5`，当`alterId`大于`0`时该用户只能使用`VMessMD5`

## 优点
相比较于`VMessMD5`，`VMessAEAD`不需要预先生成用户的认证信息，可以节省大量的内存空间

`VMessAEAD`比`VMessMD5`更安全，未来会成为主流

## 缺点
由于`VMessAEAD`不需要预先生成用户的认证信息，所以每次认证都需要遍历所有用户来进行用户认证，会导致认证时的 cpu 占用率明显上升

# heki 优化

heki 针对此种情况进行了深度优化，可以很大程度改善`VMessAEAD`认证方式的 cpu 占用率，基本让`VMessAEAD`与`VMessMD5`的性能处于同一量级

heki 还实现了 AuthenticatedLength 和 SessionHistory 安全增强，进一步提升 VMess 协议的安全性

## 真实 IP 缓存优化

只要让 heki 能`正确获取到用户真实 ip`，heki 会自动开启优化

如果用户直连 heki 服务端，则无需关心，此优化已开启

如果你使用了中转服务器，则需确保 heki `能正确获取到用户真实 ip`，详情参考: [这里](other/forward-get-real-ip.md)

### 相关配置

| 参数名                         | 默认值          | 说明                                    |
|-----------------------------|--------------|---------------------------------------|
| `ip_user_cache_time`        | `24`         | 用户 IP 缓存时间，单位: 小时                     |
| `ip_user_cache_save_enable` | `true`       | 用户 IP 缓存是否自动保存到硬盘，可有效解决重启后缓存丢失的问题，建议开启 |
| `ip_user_cache_save_dir`    | `/etc/heki/` | 用户 IP 缓存保存文件夹                         |

## 错误密码攻击优化

当用户使用错误的密码连接时，服务端`尝试所有的用户`进行`解密`数据包，最终抛出`未找到用户`的错误

每一个`错误密码`的 tcp 连接，都会让服务端`重复上述流程`，`极大增加`了服务器的 cpu 使用率，降低正常用户的体验

若这样的`错误密码`连接很多，例如攻击者`恶意攻击服务端`，服务器 cpu 占用率`直接爆满`，用户无法正常使用

### 配置
| 参数名                                         | 默认值     | 说明           |
|---------------------------------------------|---------|--------------|
| `vmess_aead_invalid_access_enable`          | `false` | 是否启用错误密码攻击优化 |
| `vmess_aead_invalid_access_count`           | `30`    | 错误次数         |
| `vmess_aead_invalid_access_duration`        | `60`    | 错误次数统计时间，单位秒 |
| `vmess_aead_invalid_access_forbidden_time`  | `600`   | 禁用时间，单位秒     |

### 功能描述

!> 此功能必须确保 heki `获取到真实 IP`，否则不要开启此功能，[中转获取真实IP](other/forward-get-real-ip.md)

!> 此功能仅针对`VMessAEAD`验证方式，若用户使用`VMessMD5`认证，则不受影响

!> `强烈建议`根据你的实际情况修改配置，默认配置`未经过任何实战`

!> 此功能有可能导致误伤正常用户，例如：用户`误操作`使用了错误的密码进行连接，`触发错误次数统计`导致被暂时封禁

以`默认配置`为例，当某个 IP 在`60`秒内`使用错误密码`尝试连接`30`次后，将会禁用此 IP`600`秒

在封禁期间，若此 IP 无论使用正确密码或错误密码连接，服务端均`直接关闭连接`，不会继续消耗服务器 cpu 进行尝试解密
