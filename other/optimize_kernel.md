# 内核调优参数

!> 如果内核参数过于保守，则会导致无法发挥机器的完整性能，造成速度低下。如果内核参数过于激进，当网络负载过高时，则会导致机器配置达不到内核参数的要求，造成内存爆满等情况

!> 每台机器的配置、网络负载情况均不相同，请根据实际情况反复调整内核参数，以达到最稳定的效果

!> 以下参数仅作为参考，照搬可能没有作用，也可能有反效果，需要根据实际情况调整

## 使用方式
将以下内容添加到`/etc/sysctl.conf`中，保存文件后，使用`sysctl -p`应用设置

```
# 开启 bbr，内核版本 >= 4.9
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# 增大可用的客户端端口范围
net.ipv4.ip_local_port_range = 1024 65535

# 尽量多复用连接
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_tw_reuse = 1

# 增大 tcp 缓冲队列，若仍然不够可适当再增加前两项
net.ipv4.tcp_max_syn_backlog = 4096
net.core.somaxconn = 4096
net.ipv4.tcp_abort_on_overflow = 1

# 服务器网络非常稳定设置 0，提升吞吐量，服务器网络不够稳定则设置 1
net.ipv4.tcp_slow_start_after_idle = 0

# 尽量少用 swap，多用物理内存；设置 0 表示不使用 swap，设置 100 表示优先使用 swap
vm.swappiness = 10

fs.file-max = 6553560

# 以下三个参数不能照搬！！！
# 1. 如果系统内存还剩余很多，但速度却很慢，很有可能是缓冲区满了，适当增加
# 2. 如果系统内存经常爆满，那么就是缓冲区设置过大了，适当降低
# 3. 反复调整参数值以达到最稳定的状态

# 调整整个系统可用于 tcp 缓冲区的大小，分别表示: <下限> <压力模式下的内存使用> <上限>，单位: 页 (一般默认 1页=4KB)
net.ipv4.tcp_mem = 164205  218941  328410
# 调整单个 tcp 连接接收缓冲区的大小，分别表示: <最小值> <默认值> <最大值>，单位: (字节)
net.ipv4.tcp_rmem = 4096  131072  6291456
# 调整单个 tcp 连接发送缓冲区的大小，分别表示: <最小值> <默认值> <最大值>，单位: (字节)
net.ipv4.tcp_wmem = 4096  16384  4194304
```
