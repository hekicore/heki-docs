# 内部性能优化

heki 在代码层面进行了多项性能优化，无需任何配置即可自动生效。

## 优化项总览

| 优化项 | 说明 |
|-------|------|
| 多级内存池复用 | 所有协议数据转发使用内存池，避免频繁分配和回收 |
| 热路径零分配 | 数据转发核心循环接近零内存分配，GC 压力极低 |
| 流量统计无锁化 | 使用原子操作替代互斥锁，高并发下无锁竞争 |
| gRPC 帧头复用 | gRPC gun 模式帧头内嵌复用，消除每次写入的堆分配 |
| VMess AEAD 解密优化 | 解密缓冲区预分配，长连接大流量时减少分配次数 |
| DNS 缓存容量保护 | 缓存设上限，满时自动淘汰，防止内存无限增长 |
| DNS 查询合并 | 相同域名并发查询只发一次请求，减少 DNS 压力 |
| 限速器 Timer 复用 | 限速等待复用 timer 对象，减少 GC 压力 |
| Buffer Pool 复用 | 5 种规格缓冲区池化管理，所有协议共用 |
| WebSocket Mask 批量 XOR | 使用批量 XOR 优化，比逐字节快数倍 |
| TLS 握手超时保护 | 10 秒握手超时，防止慢速握手攻击 |
| IP 缓存原子写入 | 写临时文件再 rename，防止断电损坏 |
| 令牌桶突发优化 | 突发容量优化，限速场景下体验更平滑 |
| 配置参数启动校验 | 启动时校验关键参数范围，配置错误即报错 |
| panic recovery 堆栈增强 | panic 时记录完整堆栈，便于排查问题 |
| License 缓存过期校验 | 防止断网场景下使用已过期的缓存 license |
| License 并发安全 | 消除多协程并发验证时的数据竞争 |

!> 以上优化均为内部实现，不改变任何协议行为，不需要修改配置文件
